{% if S_SHOW_ATTACH_BOX and FILTERS %}
{% INCLUDECSS '@imcger_imgupload/imgupload.css' %}
<script>
(function($) {  // Avoid conflicts with other libraries

'use strict';

	/*
	 * Update the relevant elements and hidden data for
	 * an attachment when page load.
	 *
	 * @param void
	 */
	phpbb.plupload.imcgerUpdateRow = function() {
		$('.file-name.ellipsis-text a').each(function() {
			const allowedExt = [{{ IUL_ALLOWED_IMAGES }}];
			let link			= $(this),
				imgUrl			= $(this).attr('href'),
				real_filename	= $(this).html(),
				searchParams	= new URLSearchParams(imgUrl.split('?')[1]),
				attach_id		= searchParams.get('id'),
				filenameArray	= real_filename.split('.'),
				isImage			= allowedExt.includes(filenameArray[filenameArray.length - 1].toLowerCase());

			// If image add thumbnail to the link
			if (isImage) {
				let getThumbnail = {{ IUL_GET_THUMBNAIL }} ? '&t=1' : '';
				link.html('<img src="' + imgUrl + getThumbnail + '" title="' + real_filename + '" alt="' + real_filename + '">');

				if ({{ S_IMCGER_FANCYBOX_VERSION > 2 ? 1 : 0 }}) {
					// If FancyBox 3, 4 or 5 aktive add FancyBox attribut to the link
					link.attr('data-fancybox', attach_id);
					link.attr('data-caption', real_filename);
				} else if (typeof $.fancybox != 'undefined') {
					// If FancyBox 2 aktive add FancyBox attribut to the link
					link.attr('class', 'fancybox');
					link.attr('rel', 'gallery' + attach_id);
					link.attr('title', real_filename);
				} else if ({{ S_LIGHTBOX_ALL_IMAGES || LIGHTBOX_RESIZE_WIDTH || LIGHTBOX_RESIZE_HEIGHT ? 1 : 0 }}) {
					// If LightBox aktive add LightBox attribut to the link
					link.attr('data-lightbox', attach_id);
					link.attr('data-title', real_filename);
				} else {
					// Do nothing wenn click on image
					link.attr('onclick', 'return false;');
				}
			}
		});
	}

	/*
	 * Update the relevant elements and hidden data for an attachment.
	 *
	 * @param {int} index The index from phpbb.plupload.ids of the attachment to edit.
	 * @param {array} downloadUrl Optional array of download urls to update.
	 */
	phpbb.plupload.updateRow = function(index, downloadUrl) {
		const allowedExt	= [{{ IUL_ALLOWED_IMAGES }}];
		let   attach		= phpbb.plupload.data[index],
			  row			= $('[data-attach-id="' + attach.attach_id + '"]'),
			  filenameArray = attach.real_filename.split('.'),
			  isImage		= allowedExt.includes(filenameArray[filenameArray.length - 1].toLowerCase());

		// Add the link to the file
		if (typeof downloadUrl !== 'undefined' && typeof downloadUrl[index] !== 'undefined') {
			let url = downloadUrl[index].replace('&amp;', '&'),
				link = $('<a></a>');

			if (isImage) {
				// If image add thumbnail to the link
				let getThumbnail = {{ IUL_GET_THUMBNAIL }} ? '&t=1' : '';
				link.attr('href', url).html('<img src="' + url + getThumbnail + '" title="' + attach.real_filename + '" alt="' + attach.real_filename + '">');

				if ({{ S_IMCGER_FANCYBOX_VERSION > 2 ? 1 : 0 }}) {
					// If FancyBox 3 or 4 aktive add FancyBox attribut to the link
					link.attr('data-fancybox', attach.attach_id);
					link.attr('data-caption', attach.real_filename);
				} else if (typeof $.fancybox != 'undefined') {
					// If FancyBox 2 aktive add FancyBox attribut to the link
					link.attr('class', 'fancybox');
					link.attr('rel', 'gallery' + attach.attach_id);
					link.attr('title', attach.real_filename);
					// Inizialisiere Fancybox 2
					link.fancybox({
						openEffect: 'none',
						closeEffect: 'none',
						helpers: {
							title: {type: 'inside'},
							buttons: {}
						}
					});
				} else if ({{ S_LIGHTBOX_ALL_IMAGES || LIGHTBOX_RESIZE_WIDTH || LIGHTBOX_RESIZE_HEIGHT ? 1 : 0 }}) {
					// If LightBox aktive add LightBox attribut to the link
					link.attr('data-lightbox', attach.attach_id);
					link.attr('data-title', attach.real_filename);
				} else {
					// Do nothing wenn click on image
					link.attr('onclick', 'return false;');
				}
			} else {
				link.attr('href', url).html(attach.real_filename);
			}

			row.find('.file-name').html(link);
		}

		row.find('textarea').attr('name', 'comment_list[' + index + ']');
		phpbb.plupload.updateHiddenData(row, attach, index);
	};

	phpbb.plupload.imcgerUpdateRow();

})(jQuery); // Avoid conflicts with other libraries
</script>
{% endif %}
