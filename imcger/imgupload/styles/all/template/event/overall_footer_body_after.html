{% if S_SHOW_ATTACH_BOX and FILTERS %}
{% INCLUDECSS '@imcger_imgupload/imgupload.css' %}
<script>
/**
 * Add inline attachment at position as image
 * AddOn for editor.js
 *
 * @param	string	fileUrl	Image file URL
 */
function imcgerAttachImage(fileUrl) {
	insert_text('[img]' + fileUrl + '[/img]');
	document.forms[form_name].elements[text_name].focus();
}

/**
 * Remove attachment in preview when insert as img BBcode in message
 * AddOn for editor.js
 *
 * @var	array	notDisplayedAttachments	Attachments that insert in the message
 * @var	bool	notDisplayAttachmentBox	Don't show any attachment
 */
function imcgerShowAttachImage() {
	const notDisplayedAttachments = {{ IUL_NOT_DISPLAYED_ATTACHMENTS }},
		  notDisplayAttachmentBox = {{ IUL_NOT_DISPLAY_ATTACHMENTBOX }};

	// Return when no attachments present
	if (typeof notDisplayAttachmentBox == 'undefined' || notDisplayAttachmentBox && !notDisplayedAttachments.length) {
		return;
	}

	if (notDisplayAttachmentBox) {
		// Hide attachment box
		document.getElementsByClassName('attachbox')[0].style.display = 'none';
	} else {
		let attachments = document.querySelectorAll(".attachbox .thumbnail");
		// Hide attachments that present in array
		attachments.forEach((attachment) => {
			let link = attachment.getElementsByTagName('a')[0].getAttribute("href");

			if (notDisplayedAttachments.includes(link.match('id=([0-9]+)')[1])) {
				attachment.parentElement.style.display = 'none';
			}
		});
	}
}
// When load the document, update AttachmentBox in preview
document.addEventListener ("DOMContentLoaded", () => {imcgerShowAttachImage();});

(function($) {  // Avoid conflicts with other libraries

	'use strict';

	/**
	 * Insert inline image bbcode.
	 */
	$('#file-list').on('click', '.image-inline-bbcode', function(e) {
		let attachId = $(this).parents('.attach-row').attr('data-attach-id');

		imcgerAttachImage('./download/file.php?mode=view&id=' + attachId);
		e.preventDefault();
	});

	/**
	 * Delete a attached file.
	 */
	$('#file-list').on('click', '.file-delete', function(e) {
		var row = $(this).parents('.attach-row'),
			attachId = row.attr('data-attach-id');

		phpbb.plupload.deleteFile(row, attachId);
		phpbb.plupload.imcgerDelImgBbcode(attachId);
		e.preventDefault();
	});

	/**
	 * Delete image BBcodes from message body when attached image is delete.
	 *
	 * @param int	attachId	The id of the attachment.
	 */
	phpbb.plupload.imcgerDelImgBbcode = function(attachId) {
		let	textarea = $('#message', phpbb.plupload.form),
			text = textarea.val();

		// Return if the bbcode isn't used at all.
		if (text.indexOf('[img') === -1) {
			return;
		}

		let regex = new RegExp('\\[img\\](.*?)(id=' + attachId + ')\\[\\/img\\]', 'g');
		text = text.replace(regex, '');

		textarea.val(text);
	};

	/**
	 * Update the relevant elements and hidden data for
	 * an attachment when page load.
	 *
	 * @param void
	 */
	phpbb.plupload.imcgerUpdateRow = function() {
		$('.file-name.ellipsis-text a').each(function() {
			const allowedExt	= {{ IUL_ALLOWED_IMAGES }};
			let link			= $(this),
				imgUrl			= $(this).attr('href'),
				real_filename	= $(this).html(),
				searchParams	= new URLSearchParams(imgUrl.split('?')[1]),
				attach_id		= searchParams.get('id'),
				filenameArray	= real_filename.split('.'),
				isImage			= allowedExt.includes(filenameArray[filenameArray.length - 1].toLowerCase());

			// If image add thumbnail to the link
			if (isImage) {
				let getThumbnail = '&t=1';
				link.html('<img src="' + imgUrl + getThumbnail + '" onerror="this.src=\'' + imgUrl + '\';" title="' + real_filename + '" alt="' + real_filename + '">');

				if ({{ IUL_IMG_SET_INLINE }}) {
					// Add button for img BBCode
					$('[data-attach-id="' + attach_id + '"]').find('.attach-controls').prepend('<input type="button" value="{{ lang("IMAGE_PLACE_INLINE")|e("js") }}" class="button2 image-inline-bbcode">&nbsp;');
				}

				if ({{ S_IMCGER_FANCYBOX_VERSION > 2 ? 1 : 0 }}) {
					// If FancyBox 3, 4 or 5 aktive add FancyBox attribut to the link
					link.attr('data-fancybox', attach_id);
					link.attr('data-caption', real_filename);
				} else if (typeof $.fancybox != 'undefined') {
					// If FancyBox 2 aktive add FancyBox attribut to the link
					link.attr('class', 'fancybox');
					link.attr('rel', 'gallery' + attach_id);
					link.attr('title', real_filename);
				} else if ({{ S_LIGHTBOX_ALL_IMAGES || LIGHTBOX_RESIZE_WIDTH || LIGHTBOX_RESIZE_HEIGHT ? 1 : 0 }}) {
					// If LightBox aktive add LightBox attribut to the link
					link.attr('data-lightbox', attach_id);
					link.attr('data-title', real_filename);
				} else {
					// Do nothing wenn click on image
					link.attr('onclick', 'return false;');
				}
			}
		});
	}

	/**
	 * Update the relevant elements and hidden data for an attachment.
	 *
	 * @param	int		index The index from phpbb.plupload.ids of the attachment to edit.
	 * @param	array	downloadUrl Optional array of download urls to update.
	 */
	phpbb.plupload.updateRow = function(index, downloadUrl) {
		const allowedExt	= {{ IUL_ALLOWED_IMAGES }};
		let   attach		= phpbb.plupload.data[index],
			  row			= $('[data-attach-id="' + attach.attach_id + '"]'),
			  filenameArray = attach.real_filename.split('.'),
			  isImage		= allowedExt.includes(filenameArray[filenameArray.length - 1].toLowerCase());

		// Add the link to the file
		if (typeof downloadUrl !== 'undefined' && typeof downloadUrl[index] !== 'undefined') {
			let url = downloadUrl[index].replace('&amp;', '&'),
				link = $('<a></a>');

			if (isImage) {
				// If image add thumbnail to the link
				let getThumbnail = '&t=1';
				link.attr('href', url).html('<img src="' + url + getThumbnail + '" onerror="this.src=\'' + url + '\';" title="' + attach.real_filename + '" alt="' + attach.real_filename + '">');

				if ({{ IUL_IMG_SET_INLINE }}) {
					// Add button for img BBCode
					row.find('.attach-controls').prepend('<input type="button" value="{{ lang("IMAGE_PLACE_INLINE")|e("js") }}" class="button2 image-inline-bbcode">&nbsp;');
				}

				if ({{ S_IMCGER_FANCYBOX_VERSION > 2 ? 1 : 0 }}) {
					// If FancyBox 3 or 4 aktive add FancyBox attribut to the link
					link.attr('data-fancybox', attach.attach_id);
					link.attr('data-caption', attach.real_filename);
				} else if (typeof $.fancybox != 'undefined') {
					// If FancyBox 2 aktive add FancyBox attribut to the link
					link.attr('class', 'fancybox');
					link.attr('rel', 'gallery' + attach.attach_id);
					link.attr('title', attach.real_filename);
					// Inizialisiere Fancybox 2
					link.fancybox({
						openEffect: 'none',
						closeEffect: 'none',
						helpers: {
							title: {type: 'inside'},
							buttons: {}
						}
					});
				} else if ({{ S_LIGHTBOX_ALL_IMAGES || LIGHTBOX_RESIZE_WIDTH || LIGHTBOX_RESIZE_HEIGHT ? 1 : 0 }}) {
					// If LightBox aktive add LightBox attribut to the link
					link.attr('data-lightbox', attach.attach_id);
					link.attr('data-title', attach.real_filename);
				} else {
					// Do nothing wenn click on image
					link.attr('onclick', 'return false;');
				}
			} else {
				link.attr('href', url).html(attach.real_filename);
			}

			row.find('.file-name').html(link);
		}

		row.find('textarea').attr('name', 'comment_list[' + index + ']');
		phpbb.plupload.updateHiddenData(row, attach, index);
	};

	phpbb.plupload.imcgerUpdateRow();

})(jQuery); // Avoid conflicts with other libraries
</script>
{% endif %}

<script>
/**
 *	Set maximum width for images in posts
 */
const imcgerImgUpload = {
	initialImage: function() {
		// Return if no content is displayed
		if (!document.getElementsByClassName("content").length) {
			return;
		}

		let postImageArray = document.querySelectorAll(".content img.postimage"),
			postbodyWidth  = window.getComputedStyle(document.getElementsByClassName("content")[0]).width;

		postImageArray.forEach((image) => {
			if (parseInt(image.naturalWidth) > parseInt(postbodyWidth)) {
				image.style.width = '100%';
				image.style.maxWidth = '{{ IUL_IMG_MAXWIDTH }}';
			} else {
				image.style.width = 'auto';
				image.style.maxWidth = 'none';
			}

		});
	},
}

// Adjust the size of images when loaded
let postImageArray = document.querySelectorAll(".content img.postimage");
postImageArray.forEach((image) => {
	image.onload = (event) => {
		let postbodyWidth  = window.getComputedStyle(document.getElementsByClassName("content")[0]).width;
		if (parseInt(image.naturalWidth) > parseInt(postbodyWidth)) {
			image.style.width = '100%';
			image.style.maxWidth = '{{ IUL_IMG_MAXWIDTH }}';
		} else {
			image.style.width = 'auto';
			image.style.maxWidth = 'none';
		}
	};
});

// When load the document, adjust the size of images
document.addEventListener ("DOMContentLoaded", () => {imcgerImgUpload.initialImage();});

// When resize the window, adjust the size of images
window.onresize = (event) => {imcgerImgUpload.initialImage();};
</script>
